<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retro Terminal Chatbot</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>

<button id="theme-toggle" class="top-toggle">Blue Mode</button>

<div id="intro-screen">
    <p>Alert: Unknown signals detected on Mars. Explorers report alien activity near the Valles Marineris canyon.
    The research team is preparing for first contact protocols. Be cautious â€” signals are unpredictable and may contain intelligence.</p>
    <p class="center">Press <strong>Space</strong> or <strong>Enter</strong> to enter the system...</p>
</div>

<div id="chat-screen">
    <div id="chat-box"></div>

    <div id="likelihood-container">
        <span>Human Likelihood:</span>
        <div id="likelihood-bar">
            <div id="likelihood-fill"></div>
        </div>
        <span id="likelihood-percent">20%</span>
    </div>

    <div id="input-row">
        <input type="text" id="user-input" placeholder="Type a message..." autofocus>
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<!-- End screen (hidden until triggered) -->
<div id="end-screen" style="display: none;">
    <div class="end-panel">
        <h1 id="end-title"></h1>
        <p id="end-sub"></p>
        <p id="end-percent"></p>
        <div class="end-actions">
            <button id="restart-btn">Restart</button>
        </div>
    </div>
</div>

<script>
    var Percentage = 0.50;

    // --- Load initial question from /start ---
    window.addEventListener("load", async () => {
        try {
            const response = await fetch("/start", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: "" // your server's /start doesn't require content
            });

            const data = await response.json();
            // data.reply is already an object in your /start implementation
            const botData = data.reply;

            // ensure UI matches initial Percentage
            updateHumanLikelihood(0); // will set UI from Percentage

            // show the first question from server
            appendBotMessage(botData.nextQuestion, "");
        } catch (err) {
            console.error("Failed to load first question:", err);
        }
    });

    // Intro -> chat transition
    document.addEventListener("keydown", function (e) {
        if (e.code === "Space" || e.code === "Enter") {
            document.getElementById("intro-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
            document.getElementById("user-input").focus();
        }
    });

    // typing helper (keeps existing behavior)
    async function typeWriter(element, text, speed = 30) {
        element.textContent = "";
        for (let i = 0; i < text.length; i++) {
            element.textContent += text[i];
            element.scrollIntoView({ behavior: "smooth", block: "end" });
            await new Promise(res => setTimeout(res, speed));
        }
    }

    // Update Percentage with a change (positive or negative), update UI and then check win/loss
    function updateHumanLikelihood(change) {
        // change is expected like -0.12 or 0.08 etc.
        Percentage = Math.max(0, Math.min(1, Percentage + change));
        const percent = Math.round(Percentage * 100);
        const fill = document.getElementById("likelihood-fill");
        fill.style.width = percent + "%";
        fill.classList.add("pulse");
        setTimeout(() => fill.classList.remove("pulse"), 400);
        document.getElementById("likelihood-percent").textContent = percent + "%";

        // small delay so user sees the bar animate before end-screen pops
        setTimeout(() => checkWinCondition(percent), 300);
    }

    // Check for win/lose and show end-screen accordingly
    function checkWinCondition(percent) {
        // Human Win (access granted)
        if (percent >= 90) {
            showEndScreen(
                "access granted",
                "Human identity confirmed. Access to Mars Control granted.",
                percent,
                "success"
            );
            return;
        }

        // Alien Loss (detected)
        if (percent < 20) {
            showEndScreen(
                "alien detected",
                "Low human-likelihood. Entity classified as non-human. Locking out.",
                percent,
                "failure"
            );
            return;
        }

        // otherwise, keep going
    }

    // Display full-screen end panel
    function showEndScreen(titleText, subText, percent, type) {
        // Hide other UIs
        document.getElementById("chat-screen").style.display = "none";
        document.getElementById("intro-screen").style.display = "none";

        // Populate
        document.getElementById("end-title").textContent = titleText.toUpperCase();
        document.getElementById("end-sub").textContent = subText;
        document.getElementById("end-percent").textContent = `Final human-likelihood: ${percent}%`;

        const endScreen = document.getElementById("end-screen");
        endScreen.classList.remove("success", "failure");
        endScreen.classList.add(type);
        endScreen.style.display = "flex";

        // focus restart for keyboard users
        document.getElementById("restart-btn").focus();
    }

    // Restart button simply reloads page (easy reset)
    document.getElementById("restart-btn").addEventListener("click", () => {
        window.location.reload();
    });

    // send message flow
    async function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value;
        if (!message) return;

        appendMessage("You", message);
        input.value = "";

        try {
            const response = await fetch("/chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message})
            });

            const data = await response.json();
            // your server returns a stringified JSON reply from the model; you parse it:
            const botData = JSON.parse(data.reply);

            // apply change (server uses field human_likelihood_change)
            updateHumanLikelihood(botData.human_likelihood_change || 0);

            // show the bot's reason + question
            appendBotMessage(botData.nextQuestion, botData.reason || "");
        } catch (err) {
            appendMessage("System", "Error contacting server.");
            console.error(err);
        }
    }

    function appendMessage(sender, text) {
        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = "message";
        msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Bot message shows reason then question (no typing animation here to keep logic simple; add back typing if desired)
    function appendBotMessage(question, reason) {
        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = "message bot-msg";

        msgDiv.innerHTML = `
            <div class="reason-text">${reason}</div>
            <strong>Chatbot:</strong> ${question}
        `;

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Enter key to send
    document.getElementById("user-input").addEventListener("keypress", function(e) {
        if (e.key === "Enter") sendMessage();
    });

    // theme toggle
    document.getElementById("theme-toggle").addEventListener("click", () => {
        document.body.classList.toggle("blue-theme");
        const isBlue = document.body.classList.contains("blue-theme");
        document.getElementById("theme-toggle").textContent = isBlue ? "Green Mode" : "Blue Mode";
    });
</script>

</body>
</html>
