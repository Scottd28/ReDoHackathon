<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retro Terminal Chatbot</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>

<button id="theme-toggle" class="top-toggle">Blue Mode</button>

<div id="intro-screen">
    <p>Alert: Unknown signals detected on Mars. Explorers report alien activity near the Valles Marineris canyon.
    The research team is preparing for first contact protocols. Be cautious — signals are unpredictable and may contain intelligence.</p>
    <p class="center">Press <strong>Space</strong> or <strong>Enter</strong> to enter the system...</p>
</div>

<div id="chat-screen" style="display: none;">
    <div id="chat-box"></div>

    <div id="likelihood-container">
        <span>Human Likelihood:</span>
        <div id="likelihood-bar">
            <div id="likelihood-fill"></div>
        </div>
        <span id="likelihood-percent">0%</span>
    </div>

    <div id="input-row">
        <input type="text" id="user-input" placeholder="Type a message..." autofocus>
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    document.addEventListener("keydown", function(e) {
        if (e.code === "Space" || e.code === "Enter") {
            document.getElementById("intro-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
            document.getElementById("chat-screen").style.flexDirection = "column";
            document.getElementById("user-input").focus();
        }
    });

    async function typeWriter(element, text, speed = 30) {
        element.textContent = "";
        for (let i = 0; i < text.length; i++) {
            element.textContent += text[i];
            element.scrollIntoView({ behavior: "smooth", block: "end" });
            await new Promise(res => setTimeout(res, speed));
        }
    }

    function updateHumanLikelihood(value) {
        const percent = Math.round(value * 100);
        const fill = document.getElementById("likelihood-fill");
        fill.style.width = percent + "%";
        fill.classList.add("pulse");
        setTimeout(() => fill.classList.remove("pulse"), 400);
        document.getElementById("likelihood-percent").textContent = percent + "%";
    }

    async function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value;
        if (!message) return;

        appendMessage("You", message);
        input.value = "";

        const response = await fetch("/chat", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message})
        });

        const data = await response.json();
        const botData = JSON.parse(data.reply);

        updateHumanLikelihood(botData.human_likelihood);
        appendBotMessage(botData.nextQuestion, botData.reason);
    }

    function appendMessage(sender, text) {
        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = "message";
        msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function appendBotMessage(question, reason) {
        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = "message bot-msg";

        msgDiv.innerHTML = `
            <div class="reason-text">${reason}</div>
            <strong>Chatbot:</strong> <span class="typing"></span>
        `;

        chatBox.appendChild(msgDiv);

        const typingSpan = msgDiv.querySelector(".typing");
        const dots = ["▮", "▮▮", "▮▮▮"];
        let dotIndex = 0;

        const typingInterval = setInterval(() => {
            typingSpan.textContent = dots[dotIndex % dots.length];
            dotIndex++;
        }, 250);

        await new Promise(res => setTimeout(res, 700));
        clearInterval(typingInterval);

        await typeWriter(typingSpan, question);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById("user-input").addEventListener("keypress", function(e) {
        if (e.key === "Enter") sendMessage();
    });

    document.getElementById("theme-toggle").addEventListener("click", () => {
        document.body.classList.toggle("blue-theme");
        const isBlue = document.body.classList.contains("blue-theme");
        document.getElementById("theme-toggle").textContent = isBlue ? "Green Mode" : "Blue Mode";
    });
</script>

</body>
</html>
