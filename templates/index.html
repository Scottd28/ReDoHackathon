<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retro Terminal Chatbot</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div id="intro-screen">
    <p>Alert: Unknown signals detected on Mars. Explorers report alien activity near the Valles Marineris canyon.
    The research team is preparing for first contact protocols. Be cautious — signals are unpredictable and may contain intelligence.</p>
    <p class="center">Press <strong>Space</strong> or <strong>Enter</strong> to enter the system...</p>
</div>

<div id="chat-screen">
    <div id="chat-box"></div>

    <!-- ✅ NEW HUMAN LIKELIHOOD BAR -->
    <div id="likelihood-container">
        <span>Human Likelihood:</span>
        <div id="likelihood-bar">
            <div id="likelihood-fill"></div>
        </div>
        <span id="likelihood-percent">0%</span>
    </div>

    <div id="input-row">
        <input type="text" id="user-input" placeholder="Type a message..." autofocus>
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    // Intro screen -> chat screen transition
    document.addEventListener("keydown", function(e) {
        if (e.code === "Space" || e.code === "Enter") {
            document.getElementById("intro-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
            document.getElementById("user-input").focus();
        }
    });

    function updateHumanLikelihood(value) {
        const percent = Math.round(value * 100);
        document.getElementById("likelihood-fill").style.width = percent + "%";
        document.getElementById("likelihood-percent").textContent = percent + "%";
    }

    async function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value;
        if (!message) return;

        await appendMessage("You", message);
        input.value = "";

        const response = await fetch("/chat", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message})
        });

        const data = await response.json();
        const botData = JSON.parse(data.reply);

        updateHumanLikelihood(botData.human_likelihood);
        await appendMessage("Chatbot", botData.nextQuestion);
    }

    function appendMessage(sender, text) {
        return new Promise(resolve => {
            const chatBox = document.getElementById("chat-box");
            const msgDiv = document.createElement("div");
            msgDiv.className = "message";
            chatBox.appendChild(msgDiv);

            let i = 0;
            const cursorSpan = document.createElement("span");
            cursorSpan.className = "cursor";
            msgDiv.appendChild(cursorSpan);

            function typeWriter() {
                if (i <= text.length) {
                    msgDiv.innerHTML = `<strong>${sender}:</strong> ${text.slice(0, i)}`;
                    msgDiv.appendChild(cursorSpan);
                    i++;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    setTimeout(typeWriter, 20);
                } else {
                    cursorSpan.remove();
                    resolve();
                }
            }
            typeWriter();
        });
    }

    // Enter key sends message
    document.getElementById("user-input").addEventListener("keypress", function(e) {
        if (e.key === "Enter") sendMessage();
    });
</script>

</body>
</html>
